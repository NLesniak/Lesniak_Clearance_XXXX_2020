---
title: "Clearance Analysis - C. difficile by time"
author: "Nicholas Lesniak"
date: "08/21/2019"
output: html_document
---

```{r setup environment, include=F}
knitr::opts_chunk$set(echo = F, warning = F, message = F)

library(tidyverse)
library(cowplot)

# file names relative to code directory for Rmd
meta_file   <- '../data/process/abx_cdiff_metadata_clean.txt'
shared_file <- '../data/mothur/abx_time.trim.contigs.good.unique.good.filter.unique.precluster.pick.pick.pick.an.unique_list.0.03.subsample.shared'
tax_file <- '../data/process/abx_cdiff_taxonomy_clean.tsv'
sum_tax_function <- '../code/sum_otu_by_taxa.R'

# read in data
meta_file   <- read.table(meta_file, sep = '\t', header = T, stringsAsFactors = F) %>% 
	mutate(mouse_id = paste(cage, mouse, sep = '_'))
shared_file <- read.table(shared_file, sep = '\t', header = T, stringsAsFactors = F, row.names = "Group") %>% 
	select(-label, -numOtus)
tax_df <- read.table(tax_file, sep = '\t', header = T, stringsAsFactors = F)
source(sum_taxa_function) # function to create taxanomic labels for OTUs

# get relative abundances
n_seqs <- unique(apply(shared_file, 1, sum))
rel_abund <- data.frame(group = row.names(shared_file), 100*shared_file/n_seqs)
min_rel_abund <- 100 * 1/n_seqs

# create a dataframe with the change in C. difficile CFU by day
differenced_cfu <- meta_file %>% 
	group_by(mouse_id) %>% 
	arrange(mouse_id, day) %>% 
	mutate(delta_cfu = CFU - lag(CFU)) %>% 
	ungroup %>% 
	mutate(delta_trend = ifelse(sign(delta_cfu) == -1, -1, 1))
# create a dataframe with the change in relative abundance by day
diff_rel_abund <- meta_file %>% 
	select(group, mouse_id, day) %>% 
	inner_join(rel_abund, by = 'group') %>% 
	group_by(mouse_id) %>% 
	arrange(mouse_id, day) %>% 
	mutate_at(vars(contains('Otu')), 
		function(otu) { otu - lag(otu) } ) %>% 
	ungroup
# categorize mice based on the colonization levels at the end of the experiment
clearance <- differenced_cfu %>% 
	group_by(mouse_id) %>% 
	summarise(last_sample = max(day)) %>% 
	left_join(differenced_cfu) %>% 
	filter(day == last_sample) %>% 
	select(mouse_id, end_point_cfu = CFU, delta_trend, delta_cfu, last_sample) %>% 
	mutate(clearance = case_when(end_point_cfu == 0 ~ 'cleared', 
		delta_trend < 0 & end_point_cfu < 100000 ~ 'clearing', # 10^5 separates the mice 
		T ~ 'colonized'))
# plot the colonization of the different colonization categories
meta_file %>% 
	left_join(clearance) %>% 	
	ggplot(aes(x = day, y = log10(CFU + 70), color = clearance, group = mouse_id)) + 
		geom_line(alpha = 0.3) + 
		facet_wrap(clearance ~ .) + 
		theme(legend.position="none")
# plot to confirm that we are not missing any mice with negatively trending C. difficile
meta_file %>% 
	left_join(clearance) %>% 	
	filter(clearance == 'colonized') %>% 
	mutate(Decreasing = ifelse(day %in% c(7:10) & delta_trend < 0, T, F)) %>% 
	ggplot(aes(x = day, y = log10(CFU + 70), color = Decreasing, group = mouse_id)) + 
		geom_line(alpha = 0.3) 
```


What is the difference between the mice that clear the colonization and those that do not within the same treatment? antibiotic? Are those differences shared across antibiotics?

```{r community difference}
clearing %>% 
	left_join(cleared) %>% 	
	filter(day >= 0, cdiff == T) %>% 
	ggplot(aes(x = day, y = (delta_trend * log10(abs(delta_cfu) + 70)), color = cleared, group = mouse_id)) + 
		geom_line(alpha = 0.3) + facet_grid(abx ~.) + 
		theme(legend.position="none")
# how many mice fall into each category per antibiotic
#meta_file %>% 
#	left_join(clearance, by = c('mouse_id')) %>% 
#	filter(cdiff == T) %>% 
#	select(mouse_id, clearance, abx) %>% 
#	unique %>% 
#	select(-mouse_id) %>% 
#	table
#clearance   amp cef cipro clinda metro none strep vanc
#  cleared     0  15     5     11    11    1    13    1
#  clearing    4   1     0      0     1    0     2    3
#  colonized  19   9     0      0     9    0    12   19
#meta_file %>% 
#	left_join(clearance, by = c('mouse_id')) %>% 
#	filter(day == 0, cdiff == T, abx == 'strep') %>% 
#	select(dose, clearance) %>% 
#	table
# cef
#dose  cleared clearing colonized
#  0.1       6        0         0
#  0.3       9        0         4
#  0.5       0        1         5
#
# metro
# delayed cleared clearing colonized
#  FALSE       1        1         5
#  TRUE       10        0         4
#
# strep
# dose  cleared clearing colonized
#  0.1      10        0         0
#  0.5       3        2         4
#  5         0        0         8

#### 
# whats the difference between the communities within antibiotic
####
test_otus <- function(antibiotic, time_point){
	if(is.numeric(time_point)){
			subset_df <- meta_file %>% 
				left_join(clearance, by = c('mouse_id')) %>% 
				filter(day == time_point)
		} else {
			subset_df <- meta_file %>% 
				left_join(clearance, by = c('mouse_id')) %>% 
				filter(day == !!(sym(time_point)))
		}
	tmp_shared_clearance <- subset_df %>% 
		filter(cdiff == T, abx %in% antibiotic, clearance != 'clearing') %>% 
		select(group, clearance) %>% 
		inner_join(rel_abund, by = c('group'))

	# select otus with median relative abundance > 1%
	tmp_otus <- tmp_shared_clearance %>% 
		select(-group, -clearance) %>% 
		gather(OTU, abundance) %>% 
		group_by(OTU) %>% 
		summarise(median_abundance = median(abundance)) %>% 
		filter(median_abundance > 1) %>% 
		pull(OTU)

    warn_orig <- options("warn")$warn
	options("warn"= -1)

	sig_otus <- tmp_shared_clearance %>% 
		select(one_of(tmp_otus)) %>% 
		mutate_all(function(otu) {
			x <- otu[tmp_shared_clearance$clearance == 'cleared']
			y <- otu[tmp_shared_clearance$clearance == 'colonized']
			wilcox.test(x, y)$p.value}) %>% 
		unique %>% 
		gather(OTU, pvalue) %>% 
		mutate(pvalue = p.adjust(pvalue, method = 'BH')) %>% 
		filter(pvalue < 0.05)

	options('warn' = warn_orig)

	if(nrow(sig_otus) < 1){
			print(paste('No significant OTUs for comparison -', paste(antibiotic, collapse = '_'), 
				'time point -', time_point))
			return(data.frame(antibiotic = paste(antibiotic, collapse = '_'),
				time_point = as.character(time_point), stringsAsFactors = F)) 
		} else {
			tmp_shared_clearance <- tmp_shared_clearance %>% 
				select(group, clearance, one_of(sig_otus$OTU)) %>% 
				gather(OTU, abundance, contains('Otu')) %>% 
				left_join(tax_df, by = c('OTU')) %>% 
				left_join(sig_otus, by = c('OTU')) 

			return(data.frame(tmp_shared_clearance, antibiotic = paste(antibiotic, collapse = '_'),
				time_point = as.character(time_point), stringsAsFactors = F)) 
		}
}

treatment_list <- list('cef', 'metro', 'strep', c('cef', 'metro', 'strep'), 
		c("clinda", "vanc", "cipro", "amp", "cef", "metro", "strep"))

d0_test_output_df <- map_dfr(treatment_list, ~ test_otus(.x, 0))
end_test_output_df <- map_dfr(treatment_list, ~ test_otus(.x, 'last_sample'))

test_output_df <- rbind(d0_test_output_df, end_test_output_df)

differential_abundance_plot <- function(df, treatment_group){
	lod_df <- data.frame(x = 0.75, y = min_rel_abund)
	temp_df <- df %>% 
		filter(antibiotic == treatment_group) %>% 
		mutate(tax_pval = paste0(tax_otu_label, '\n(p=', 
				formatC(pvalue, format = "e", digits = 2), ')')) 
	temp_df %>% 
		right_join(., group_by(., OTU) %>% 
				summarise(order = mean(abundance)),
			by = c('OTU')) %>% 
		right_join(., group_by(., OTU, clearance) %>% 
				summarise(median_abundance = (median(abundance)) + 0.04),
			by = c('OTU', 'clearance')) %>% 
		select(-group, -abundance) %>% distinct %>% 
		spread(clearance, median_abundance) %>% 
		full_join(select(temp_df, abundance, clearance, tax_otu_label)) %>% 
		filter(!is.na(clearance)) %>% 
		ggplot(aes(x = reorder(tax_pval, -order), color = clearance)) + 
			geom_hline(data = lod_df, aes(yintercept = y), size = 0.5, 
				linetype = 'solid', color = 'black') + 
			geom_hline(data = lod_df, aes(yintercept = y), size = 1, 
				linetype = 'dashed', color = 'white') + 
			geom_point(aes(y = (abundance) + 0.04), 
				position = position_dodge(width = 0.5), alpha = 0.2) + 
			geom_segment(aes(y = colonized, yend = cleared, 
				xend = reorder(tax_pval, -order)), color = 'black') + 
			geom_point(aes(y = colonized), color = 'cyan4', size = 3) + 
			geom_point(aes(y = cleared), color = 'red3', size = 3) +
			scale_y_log10() + coord_flip() + 
			theme_bw() +  
			labs(x = NULL, y = 'Relative Abundance (%)', title = paste0('Differentially abundant OTUs between cleared and colonized communities for ', 
				paste(treatment_group, collapse = ' '))) + 
			theme(legend.position = c(0.9, 0.95), 
				legend.background = element_rect(color = "black"),
				legend.title = element_blank()) + 
			geom_label(data = lod_df, aes(x = x, y = y), label = "LOD", 
				fill = "white", color = 'black', label.size = NA, inherit.aes = FALSE)  + 
			facet_wrap(.~time_point, scales = 'free_y', ncol = 1)
}

differential_abundance_plot(test_output_df, 'cef')
differential_abundance_plot(test_output_df, 'metro')
differential_abundance_plot(test_output_df, 'strep')
differential_abundance_plot(test_output_df, paste(treatment_list[[4]], collapse = '_'))
differential_abundance_plot(test_output_df, paste(treatment_list[[5]], collapse = '_'))

test_output_df %>% 
	select(antibiotic, tax_otu_label, pvalue, time_point) %>% 
	unique %>% 
	count(tax_otu_label) %>% 
	filter(n > 1) %>% 
	arrange(desc(n))
install.packages('VennDiagram')
library(VennDiagram)


```



What changes lead to clearance?
What changes associate with decreases in CFU?

```{r}

####
#  test difference between day 0 and last day for mice that clear
####


test_otus <- function(antibiotic){
	tmp_shared_cleared <- meta_file %>% 
		left_join(clearance, by = c('mouse_id')) %>% 
			filter(day == 0 | day == last_sample, 
				abx != 'none',
				cdiff == T,
				clearance == 'cleared', 
				abx %in% antibiotic) %>% 
		select(group, day) %>% 
		inner_join(rel_abund, by = c('group'))

	# select otus with median relative abundance > 1%
	tmp_otus <- tmp_shared_cleared %>% 
		select(-group, -day) %>% 
		gather(OTU, abundance) %>% 
		group_by(OTU) %>% 
		summarise(median_abundance = median(abundance)) %>% 
		filter(median_abundance > 0.5) %>% 
		pull(OTU)

    warn_orig <- options("warn")$warn
	options("warn"= -1)

	sig_otus <- tmp_shared_cleared %>% 
		select(one_of(tmp_otus)) %>% 
		mutate_all(function(otu) {
			x <- otu[tmp_shared_cleared$day  == 0]
			y <- otu[tmp_shared_cleared$day > 5]
			wilcox.test(x, y)$p.value}) %>% 
		unique %>% 
		gather(OTU, pvalue) %>% 
		mutate(pvalue = p.adjust(pvalue, method = 'BH')) %>% 
		filter(pvalue < 0.05)

	options('warn' = warn_orig)

	if(nrow(sig_otus) < 1){
			print(paste('No significant OTUs for comparison -', paste(antibiotic, collapse = '_')))
			return(data.frame(antibiotic = paste(antibiotic, collapse = '_'),
				stringsAsFactors = F)) 
		} else {
			tmp_shared_cleared <- tmp_shared_cleared %>% 
				select(group, day, one_of(sig_otus$OTU)) %>% 
				gather(OTU, abundance, contains('Otu')) %>% 
				left_join(tax_df, by = c('OTU')) %>% 
				left_join(sig_otus, by = c('OTU')) 

			return(data.frame(tmp_shared_cleared, antibiotic = paste(antibiotic, collapse = '_'),
				stringsAsFactors = F)) 
		}
}

test_change_cleared_df <- map_dfr(treatment_list, ~ test_otus(.x))

differential_abundance_plot <- function(df, treatment_group){
	lod_df <- data.frame(x = 0.75, y = min_rel_abund)
	temp_df <- df %>% 
		filter(antibiotic == treatment_group) %>% 
		mutate(tax_pval = paste0(tax_otu_label, '\n(p=', 
				formatC(pvalue, format = "e", digits = 2), ')'),
			time_point = ifelse(day ==0, 'Initial', 'End')) 
	temp_df %>% 
		right_join(., group_by(., OTU) %>% 
				summarise(order = mean(abundance)),
			by = c('OTU')) %>% 
		right_join(., group_by(., OTU, time_point) %>% 
				summarise(median_abundance = (median(abundance)) + 0.04),
			by = c('OTU', 'time_point')) %>% 
		select(-group, -abundance, -day) %>% distinct %>% 
		spread(time_point, median_abundance) %>% 
		full_join(select(temp_df, abundance, time_point, tax_otu_label)) %>% 
		filter(!is.na(time_point)) %>% 
		ggplot(aes(x = reorder(tax_pval, -order), color = time_point)) + 
			geom_hline(data = lod_df, aes(yintercept = y), size = 0.5, 
				linetype = 'solid', color = 'black') + 
			geom_hline(data = lod_df, aes(yintercept = y), size = 1, 
				linetype = 'dashed', color = 'white') + 
			geom_point(aes(y = (abundance) + 0.04), 
				position = position_dodge(width = 0.5), alpha = 0.2) + 
			geom_segment(aes(y = Initial, yend = End, 
				xend = reorder(tax_pval, -order)), color = 'black') + 
			geom_point(aes(y = Initial), color = 'cyan4', size = 3) + 
			geom_point(aes(y = End), color = 'red3', size = 3) +
			scale_y_log10() + coord_flip() + 
			theme_bw() +  
			labs(x = NULL, y = 'Relative Abundance (%)', title = paste0('Differentially abundant OTUs over time of clearing C. difficile for ', 
				paste(treatment_group, collapse = ' '))) + 
			theme(legend.position = c(0.9, 0.95), 
				legend.background = element_rect(color = "black"),
				legend.title = element_blank()) + 
			geom_label(data = lod_df, aes(x = x, y = y), label = "LOD", 
			 	fill = "white", color = 'black', label.size = NA, inherit.aes = FALSE)
}

differential_abundance_plot(test_change_cleared_df, 'strep')
differential_abundance_plot(test_change_cleared_df, 'cef')
differential_abundance_plot(test_change_cleared_df, 'metro')
differential_abundance_plot(test_change_cleared_df, treatment_list[[4]])
differential_abundance_plot(test_change_cleared_df, treatment_list[[5]])

####
# test for association between changes in cfu and changes in otus
####


```


Does abundance, z-score, or change in abundance predict change in CFU?
	Model - RF/SVM/Logistic L2
	Prediction - Overall colonization trend, change in CFU, Endpoint cleared (T/F) or level (High/Mid/Low/None)
	Features - Temporal object, prior day level, change in abundance, summary of temporal abundance (mean/median/SD/min/max/trend), abundance metric (~RMS/area of movement)
What is the network interactions of each antibiotic?
	network via spieceasi

Akkermansia seems to bloom in response to C. difficile colonization
-  Compare level of Akkermansia in samples with C. difficile and those without
-  Compare level of Akkermansia in samples challenged with C. difficile to the unchallenged samples

Are there any cases with similar communities but different coloniation dynamics? 

What is the difference between uncolonized and colonized within the same treatments? Are those differences shared across treatments?
	Are they similar to features associated with clearance?


```{r analysis}

```