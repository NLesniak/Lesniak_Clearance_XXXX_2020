---
title: "Clearance Analysis - C. difficile by time"
author: "Nicholas Lesniak"
date: "08/21/2019"
output: html_document
---

```{r setup environment, include=F}
knitr::opts_chunk$set(echo = F, warning = F, message = F)

library(tidyverse)
library(cowplot)

# file names relative to code directory for Rmd
meta_file   <- '../data/process/abx_cdiff_metadata_clean.txt'
shared_file <- '../data/mothur/abx_time.trim.contigs.good.unique.good.filter.unique.precluster.pick.pick.pick.an.unique_list.0.03.subsample.shared'
tax_file <- '../data/process/abx_cdiff_taxonomy_clean.tsv'
sum_taxa_function <- '../code/sum_otu_by_taxa.R'

# read in data
meta_file   <- read.table(meta_file, sep = '\t', header = T, stringsAsFactors = F) %>% 
	mutate(mouse_id = paste(cage, mouse, sep = '_'))
shared_file <- read.table(shared_file, sep = '\t', header = T, stringsAsFactors = F, row.names = "Group") %>% 
	select(-label, -numOtus)
tax_df <- read.table(tax_file, sep = '\t', header = T, stringsAsFactors = F)
source(sum_taxa_function) # function to create taxanomic labels for OTUs

# get relative abundances
n_seqs <- unique(apply(shared_file, 1, sum))
rel_abund <- data.frame(group = row.names(shared_file), 100*shared_file/n_seqs,
	stringsAsFactors = F)
min_rel_abund <- 100 * 1/n_seqs

# create a dataframe with the change in C. difficile CFU by day
differenced_cfu <- meta_file %>% 
	group_by(mouse_id) %>% 
	arrange(mouse_id, day) %>% 
	mutate(delta_cfu = CFU - lag(CFU)) %>% 
	ungroup %>% 
	mutate(delta_trend = ifelse(sign(delta_cfu) == -1, -1, 1))
# create a dataframe with the change in relative abundance by day
diff_rel_abund <- meta_file %>% 
	select(group, mouse_id, day) %>% 
	inner_join(rel_abund, by = 'group') %>% 
	group_by(mouse_id) %>% 
	arrange(mouse_id, day) %>% 
	mutate_at(vars(contains('Otu')), 
		function(otu) { otu - lag(otu) } ) %>% 
	ungroup
## for ML - second differenced
#diff_rel_abund <- meta_file %>% 
#	select(group, mouse_id, day) %>% 
#	inner_join(rel_abund, by = 'group') %>% 
#	group_by(mouse_id) %>% 
#	arrange(mouse_id, day) %>% 
#	mutate_at(vars(contains('Otu')), 
#		function(otu) { otu - lag(otu) } ) %>% 
#	ungroup
#otu1 <- sample(1:100,10)
#cfu1 <- sample(1:100,10)
#lag(otu1) - lag(otu1, 2)
#otu1 - lag(otu1)
#cfu1 - lag(cfu1)

# categorize mice based on the colonization levels at the end of the experiment
clearance <- differenced_cfu %>% 
	group_by(mouse_id) %>% 
	summarise(last_sample = max(day),
		max_cfu = max(CFU)) %>% 
	left_join(differenced_cfu, by = c('mouse_id')) %>% 
	filter(day == last_sample,
		max_cfu > 0) %>% 
	select(mouse_id, end_point_cfu = CFU, delta_trend, delta_cfu, last_sample, max_cfu) %>% 
	mutate(clearance = case_when(end_point_cfu == 0 ~ 'cleared', 
		delta_trend < 0 & end_point_cfu < 100000 ~ 'clearing', # 10^5 separates the mice 
		T ~ 'colonized'))
## plot the colonization of the different colonization categories
#meta_file %>% 
#	left_join(clearance) %>% 	
#	ggplot(aes(x = day, y = log10(CFU + 70), color = clearance, group = mouse_id)) + 
#		geom_line(alpha = 0.3) + 
#		facet_wrap(clearance ~ .) + 
#		theme(legend.position="none")
## plot to confirm that we are not missing any mice with negatively trending C. difficile
#meta_file %>% 
#	left_join(clearance) %>% 	
#	filter(clearance == 'colonized') %>% 
#	mutate(Decreasing = ifelse(day %in% c(7:10) & delta_trend < 0, T, F)) %>% 
#	ggplot(aes(x = day, y = log10(CFU + 70), color = Decreasing, group = mouse_id)) + 
#		geom_line(alpha = 0.3) 
```


What is the difference between the mice that clear the colonization and those that do not within the same treatment? antibiotic? Are those differences shared across antibiotics?

```{r community difference}
#clearing %>% 
#	left_join(cleared) %>% 	
#	filter(day >= 0, cdiff == T) %>% 
#	ggplot(aes(x = day, y = (delta_trend * log10(abs(delta_cfu) + 70)), color = cleared, group = mouse_id)) + 
#		geom_line(alpha = 0.3) + facet_grid(abx ~.) + 
#		theme(legend.position="none")
# how many mice fall into each category per antibiotic
#meta_file %>% 
#	left_join(clearance, by = c('mouse_id')) %>% 
#	filter(cdiff == T) %>% 
#	select(mouse_id, clearance, abx) %>% 
#	unique %>% 
#	select(-mouse_id) %>% 
#	table
#clearance   amp cef cipro clinda metro none strep vanc
#  cleared     0  15     5     11    11    1    13    1
#  clearing    4   1     0      0     1    0     2    3
#  colonized  19   9     0      0     9    0    12   19
#meta_file %>% 
#	left_join(clearance, by = c('mouse_id')) %>% 
#	filter(day == 0, cdiff == T, abx == 'strep') %>% 
#	select(dose, clearance) %>% 
#	table
# cef
#dose  cleared clearing colonized
#  0.1       6        0         0
#  0.3       9        0         4
#  0.5       0        1         5
#
# metro
# delayed cleared clearing colonized
#  FALSE       1        1         5
#  TRUE       10        0         4
#
# strep
# dose  cleared clearing colonized
#  0.1      10        0         0
#  0.5       3        2         4
#  5         0        0         8

#### 
# whats the difference between the communities within antibiotic
####
test_otus <- function(antibiotic, time_point){
	if(is.numeric(time_point)){
			subset_df <- meta_file %>% 
				left_join(clearance, by = c('mouse_id')) %>% 
				filter(day == time_point)
		} else {
			subset_df <- meta_file %>% 
				left_join(clearance, by = c('mouse_id')) %>% 
				filter(day == !!(sym(time_point)))
		}
	tmp_shared_clearance <- subset_df %>% 
		filter(cdiff == T, abx %in% antibiotic, clearance != 'clearing') %>% 
		select(group, clearance) %>% 
		inner_join(rel_abund, by = c('group'))

	# select otus with median relative abundance > 1%
	tmp_otus <- tmp_shared_clearance %>% 
		select(-group, -clearance) %>% 
		gather(OTU, abundance) %>% 
		group_by(OTU) %>% 
		summarise(median_abundance = median(abundance)) %>% 
		filter(median_abundance > 0.5) %>% 
		pull(OTU)

    warn_orig <- options("warn")$warn
	options("warn"= -1)

	sig_otus <- tmp_shared_clearance %>% 
		select(one_of(tmp_otus)) %>% 
		mutate_all(function(otu) {
			x <- otu[tmp_shared_clearance$clearance == 'cleared']
			y <- otu[tmp_shared_clearance$clearance == 'colonized']
			wilcox.test(x, y)$p.value}) %>% 
		unique %>% 
		gather(OTU, pvalue) %>% 
		mutate(pvalue = p.adjust(pvalue, method = 'BH')) %>% 
		filter(pvalue < 0.05)

	options('warn' = warn_orig)

	if(nrow(sig_otus) < 1){
			print(paste('No significant OTUs for comparison -', paste(antibiotic, collapse = '_'), 
				'time point -', time_point))
			return(data.frame(antibiotic = paste(antibiotic, collapse = '_'),
				time_point = as.character(time_point), stringsAsFactors = F)) 
		} else {
			tmp_shared_clearance <- tmp_shared_clearance %>% 
				select(group, clearance, one_of(sig_otus$OTU)) %>% 
				gather(OTU, abundance, contains('Otu')) %>% 
				left_join(tax_df, by = c('OTU')) %>% 
				left_join(sig_otus, by = c('OTU')) 

			return(data.frame(tmp_shared_clearance, antibiotic = paste(antibiotic, collapse = '_'),
				time_point = as.character(time_point), stringsAsFactors = F)) 
		}
}

treatment_list <- list('cef', 'metro', 'strep', c('cef', 'metro', 'strep'), 
		c("clinda", "vanc", "amp", "cef", "metro", "strep"))

d0_test_output_df <- map_dfr(treatment_list, ~ test_otus(.x, 0))
end_test_output_df <- map_dfr(treatment_list, ~ test_otus(.x, 'last_sample'))

test_output_df <- rbind(d0_test_output_df, end_test_output_df)

differential_abundance_plot <- function(df, treatment_group){
	# create dataframe for the plot location of limit of detection
	lod_df <- data.frame(x = 0.75, y = min_rel_abund)
	temp_df <- df %>% 
		filter(antibiotic == treatment_group) %>% # subset by treatment
		mutate(tax_pval = paste0(tax_otu_label, '\n(p=', 
				formatC(pvalue, format = "e", digits = 2), ')'),
			tax_pval = gsub('_unclassified', '', tax_pval), # create label with taxonomy and p value
			time_point = case_when(time_point == '0' ~ 'Day 0', 
				time_point == 'last_sample' ~ 'Day 10')) # convert timepoint labels
	plot_output <- temp_df %>% 
		right_join(., group_by(., OTU) %>% 
				summarise(order = mean(abundance)),
			by = c('OTU')) %>% 
		right_join(., group_by(., OTU, time_point, clearance) %>% 
				summarise(median_abundance = (median(abundance)) + 0.04),
			by = c('OTU', 'clearance', 'time_point')) %>% 
		select(-group, -abundance) %>% distinct %>% 
		spread(clearance, median_abundance) %>% 
		full_join(select(temp_df, abundance, clearance, time_point, tax_otu_label),
			by = c("time_point", "tax_otu_label")) %>% 
		filter(!is.na(clearance)) %>% 
		ggplot(aes(x = reorder(tax_pval, -order), color = clearance)) + 
			geom_hline(data = lod_df, aes(yintercept = y), size = 0.5, 
				linetype = 'solid', color = 'black') + 
			geom_hline(data = lod_df, aes(yintercept = y), size = 1, 
				linetype = 'dashed', color = 'white') + 
			geom_point(aes(y = (abundance) + 0.04), 
				position = position_dodge(width = 0.5), alpha = 0.2) + 
			geom_segment(aes(y = colonized, yend = cleared, 
				xend = reorder(tax_pval, -order)), color = 'black') + 
			geom_point(aes(y = colonized), color = 'cyan4', size = 3) + 
			geom_point(aes(y = cleared), color = 'red3', size = 3) +
			scale_y_log10() + coord_flip() + 
			theme_bw() +  
			labs(x = NULL, y = 'Relative Abundance (%)', title = paste0('Differentially abundant OTUs between\ncleared and colonized communities for ', 
				paste(treatment_group, collapse = ' ')), 
			subtitle = 'Plotted only statically significant by Wilcoxon after BH correction') + 
			theme(legend.position = c(0.85, 0.95), 
				legend.background = element_rect(color = "black"),
				legend.title = element_blank()) + 
			geom_label(data = lod_df, aes(x = x, y = y), label = "LOD", 
				fill = "white", color = 'black', label.size = NA, inherit.aes = FALSE)  + 
			facet_grid(time_point~., scales = 'free_y', space = 'free')
#	ggsave(paste0('../results/figures/clearance_diff_abund_', treatment_group, '.jpg'), 
#		plot_output, width = 6, height = .5*length(unique(temp_df$OTU)))
}

cef_diff_abund <- differential_abundance_plot(test_output_df, 'cef')
metro_diff_abund <- differential_abundance_plot(test_output_df, 'metro')
strep_diff_abund <- differential_abundance_plot(test_output_df, 'strep')
#differential_abundance_plot(test_output_df, paste(treatment_list[[4]], collapse = '_'))
all_diff_abund <- differential_abundance_plot(test_output_df, paste(treatment_list[[5]], collapse = '_'))

## what is the overlap of significant otus?
#test_output_df %>% 
#	select(antibiotic, tax_otu_label, pvalue, time_point) %>% 
#	unique %>% 
#	count(tax_otu_label) %>% 
#	filter(n > 1) %>% 
#	arrange(desc(n))
##install.packages('VennDiagram')
#library(VennDiagram)


```

# Comparing communities that cleared the infection to those that remained colonized
When looking at all treatments together, there were 4 OTUs that were statistically significant. At the end of the experiment, Lactobacillus (OTU 11) and turicibacter (OTU 15) were in higher abundance in mice that remained colonized. Whereas Porphyromoadaceae (OTU 3) and Bacteroides (OTU 4) were abunant at much greater levels in mice that cleared the colonization.

```{r all plot, eval=F}
all_diff_abund
```

Next we looked at the differences within each antibiotic treatment that had mice that cleared and mice that remained colonized. Since each antibiotic resulted specific changes that could be masked by other treatments, we looked at the individual communities to see what changes were unique to each treatment.
In metronidazole treatment, at the time of C. difficile challenge comunities that cleared the colonization had much higher levels of Lachnospiraceae (OTU 34), turicibacter (OTU 15) and Barnesiella (OTU 7) and lower levels of Lactobacillus (OTU 11). 
In streptomycin treatment, the differences between the communities that cleared and those that remained colonized are largely related to a set of Porphyromonadaceae OTUs. At both the time of challenge and endpoint, Barnesiella was higher in the mice that remained colonized. For the mice that cleared C difficile colonization, at the time of challenge Porphyromonadaceae (OTUs 5, 13 and 18) were higher, and at the endpoint Porphyromonadaceae (OTU 19), Alistipes (OTU 22) and Lactobacillus (OTU 17) were higher. Lastly, the endpoint Porphyromonadaceae (OTU 3) was higher at in colonized communities.
In cefaperazone treatment, communities that cleared colonization had higher abundances of Porphyromonadaceae (OTUs 5 and 9) and Barnesiella (OTU 7) at the endpoint. Whereas, Turicibacter (OTU 15) was higher in colonized mice at the end of the experiment.  

```{r cef plot, eval=F}
cef_diff_abund
```

```{r metro plot, eval=F}
metro_diff_abund
```

```{r strep plot, eval=F}
strep_diff_abund
```


What changes lead to clearance?
What changes associate with decreases in CFU?

```{r}

####
#  test difference between day 0 and last day for mice that clear
####


test_otus <- function(antibiotic){
	tmp_shared_cleared <- meta_file %>% 
		left_join(clearance, by = c('mouse_id')) %>% 
			filter(day == 0 | day == last_sample, 
				abx != 'none',
				cdiff == T,
				clearance == 'cleared', 
				abx %in% antibiotic) %>% 
		select(group, day) %>% 
		inner_join(rel_abund, by = c('group'))

	# select otus with median relative abundance > 1%
	tmp_otus <- tmp_shared_cleared %>% 
		select(-group, -day) %>% 
		gather(OTU, abundance) %>% 
		group_by(OTU) %>% 
		summarise(median_abundance = median(abundance)) %>% 
		filter(median_abundance > 0.5) %>% 
		pull(OTU)

    warn_orig <- options("warn")$warn
	options("warn"= -1)

	sig_otus <- tmp_shared_cleared %>% 
		select(one_of(tmp_otus)) %>% 
		mutate_all(function(otu) {
			x <- otu[tmp_shared_cleared$day  == 0]
			y <- otu[tmp_shared_cleared$day > 5]
			wilcox.test(x, y)$p.value}) %>% 
		unique %>% 
		gather(OTU, pvalue) %>% 
		mutate(pvalue = p.adjust(pvalue, method = 'BH')) %>% 
		filter(pvalue < 0.05)

	options('warn' = warn_orig)

	if(nrow(sig_otus) < 1){
			print(paste('No significant OTUs for comparison -', paste(antibiotic, collapse = '_')))
			return(data.frame(antibiotic = paste(antibiotic, collapse = '_'),
				stringsAsFactors = F)) 
		} else {
			tmp_shared_cleared <- tmp_shared_cleared %>% 
				select(group, day, one_of(sig_otus$OTU)) %>% 
				gather(OTU, abundance, contains('Otu')) %>% 
				left_join(tax_df, by = c('OTU')) %>% 
				left_join(sig_otus, by = c('OTU')) 

			return(data.frame(tmp_shared_cleared, antibiotic = paste(antibiotic, collapse = '_'),
				stringsAsFactors = F)) 
		}
}

test_change_cleared_df <- map_dfr(treatment_list, ~ test_otus(.x))

differential_abundance_plot <- function(df, treatment_group){
	lod_df <- data.frame(x = 0.75, y = min_rel_abund)
	temp_df <- df %>% 
		filter(antibiotic == treatment_group) %>% 
		mutate(tax_pval = paste0(tax_otu_label, '\n(p=', 
				formatC(pvalue, format = "e", digits = 2), ')'),
			time_point = ifelse(day ==0, 'Initial', 'End')) 
	temp_df %>% 
		right_join(., group_by(., OTU) %>% 
				summarise(order = mean(abundance)),
			by = c('OTU')) %>% 
		right_join(., group_by(., OTU, time_point) %>% 
				summarise(median_abundance = (median(abundance)) + 0.04),
			by = c('OTU', 'time_point')) %>% 
		select(-group, -abundance, -day) %>% distinct %>% 
		spread(time_point, median_abundance) %>% 
		full_join(select(temp_df, abundance, time_point, tax_otu_label),
			by = c('tax_otu_label')) %>% 
		filter(!is.na(time_point)) %>% 
		ggplot(aes(x = reorder(tax_pval, -order), color = time_point)) + 
			geom_hline(data = lod_df, aes(yintercept = y), size = 0.5, 
				linetype = 'solid', color = 'black') + 
			geom_hline(data = lod_df, aes(yintercept = y), size = 1, 
				linetype = 'dashed', color = 'white') + 
			geom_point(aes(y = (abundance) + 0.04), 
				position = position_dodge(width = 0.5), alpha = 0.2) + 
			geom_segment(aes(y = Initial, yend = End, 
				xend = reorder(tax_pval, -order)), color = 'black') + 
			geom_point(aes(y = Initial), color = 'cyan4', size = 3) + 
			geom_point(aes(y = End), color = 'red3', size = 3) +
			scale_y_log10() + coord_flip() + 
			theme_bw() +  
			labs(x = NULL, y = 'Relative Abundance (%)', title = paste0('Differentially abundant OTUs over time of clearing C. difficile for ', 
				paste(treatment_group, collapse = ' '))) + 
			theme(legend.position = c(0.9, 0.95), 
				legend.background = element_rect(color = "black"),
				legend.title = element_blank()) + 
			geom_label(data = lod_df, aes(x = x, y = y), label = "LOD", 
			 	fill = "white", color = 'black', label.size = NA, inherit.aes = FALSE)
}

differential_abundance_plot(test_change_cleared_df, 'strep')
differential_abundance_plot(test_change_cleared_df, 'cef')
differential_abundance_plot(test_change_cleared_df, 'metro')
differential_abundance_plot(test_change_cleared_df, 'clinda')
differential_abundance_plot(test_change_cleared_df, treatment_list[[4]])
differential_abundance_plot(test_change_cleared_df, treatment_list[[5]])
```


```{r test for association of changes in otu/cfu, eval = F}


####
# test for association between changes in cfu and changes in otus
####
diff_trt_list <- list('amp', 'clinda', 'cef', 'metro', 'strep', 'vanc',
		c("clinda", "vanc", "amp", "cef", "metro", "strep"))

corr_otu <- diff_rel_abund %>% 
	inner_join(differenced_cfu, by = 'group') %>% 
	mutate(diff_cfu = case_when(delta_cfu > 0 ~ log10(delta_cfu),
		delta_cfu < 0 ~ -log10(-delta_cfu),
		delta_cfu == 0 ~ 0)) %>% 
	filter(diff_cfu > 0) %>% 
	select(diff_cfu, contains('Otu')) %>% 
	gather(otu, delta_abund, contains('Otu')) %>% 
	filter(!is.na(delta_abund)) %>% 
	group_by(otu) %>% 
	summarise(median_delta_abund = median(delta_abund),
		rho = cor.test(diff_cfu, delta_abund, method = 'spearman')$estimate,
		pvalue = cor.test(diff_cfu, delta_abund, method = 'spearman')$p.value) %>% 
	mutate(pvalue_BH = p.adjust(as.numeric(pvalue), method = 'BH'),
		pvalue_bon = p.adjust(as.numeric(pvalue), method = 'bonferroni')) %>% 
	filter(pvalue_BH <= 0.05) %>% 
	arrange(rho)

meta_file %>% 
	inner_join(rel_abund, by = 'group') %>% 
	select(mouse_id, CFU, day, abx, one_of(corr_otu$otu)) %>% 
	filter(day >= 0, !abx %in% c('cipro', 'none')) %>% 
	gather(otu, rel_abund, contains('Otu00')) %>% 
	left_join(tax_df, by = c('otu' = 'OTU')) %>% 
	mutate(CFU = log10(CFU + 60),
		rel_abund = log10(rel_abund + 0.04)) %>% 
	gather(bacteria, abundance, rel_abund, CFU) %>% 
	ggplot(aes(y = abundance, x = day)) + 
		geom_line(aes(color = bacteria, group = mouse_id)) + 
		theme_bw() + 
		facet_grid(bacteria~abx, scales = 'free_y') + 
		labs(x = 'Relative Abundance', y = 'C.difficile CFU')

corr_otu <- function(antibiotic){
	tmp_otus <- meta_file %>% 
		left_join(clearance, by = c('mouse_id')) %>% 
		filter(day > 0, 
			clearance == 'cleared'
			cdiff == T,
			abx %in% antibiotic) %>% 
		select(group, day) %>% 
		inner_join(rel_abund, by = c('group')) %>% 
		select(-group, -day) %>% 
		gather(OTU, abundance) %>% 
		group_by(OTU) %>% 
		summarise(median_abundance = median(abundance)) %>% 
		filter(median_abundance > 0) %>% 
		pull(OTU)	

	tmp_df <- diff_rel_abund %>% 
		select(group, mouse_id, day, one_of(tmp_otus)) %>% 
		inner_join(differenced_cfu, by = 'group') %>% 
		mutate(diff_cfu = case_when(delta_cfu > 0 ~ log10(delta_cfu),
			delta_cfu < 0 ~ -log10(-delta_cfu),
			delta_cfu == 0 ~ 0)) %>% 
		filter(diff_cfu != 0, abx %in% antibiotic) %>% 
		select(diff_cfu, contains('Otu')) %>% 
		gather(otu, delta_abund, contains('Otu')) %>% 
		filter(!is.na(delta_abund)) %>% 
		group_by(otu) %>% 
		summarise(median_delta_abund = median(delta_abund),
			rho = cor.test(diff_cfu, delta_abund, method = 'spearman')$estimate,
			pvalue = cor.test(diff_cfu, delta_abund, method = 'spearman')$p.value) %>% 
		mutate(pvalue_BH = p.adjust(as.numeric(pvalue), method = 'BH'),
			pvalue_bon = p.adjust(as.numeric(pvalue), method = 'bonferroni')) %>% 
		filter(pvalue_BH <= 0.05) %>% 
		arrange(rho)
	return(tmp_df  %>% 
			mutate(treatment = paste(antibiotic, collapse = '_')))
}

diff_corr_otus <- map_dfr(diff_trt_list, ~ corr_otu(.x))
left_join(diff_corr_otus, tax_df, by = c('otu' = 'OTU')) %>% 
	select(treatment, otu)

plot_diff_corr <- function(antibiotic){
	meta_file %>% 
		inner_join(rel_abund, by = 'group') %>% 
		select(mouse_id, CFU, day, abx, 
			one_of(diff_corr_otus$otu[diff_corr_otus$treatment == paste(antibiotic, collapse = '_')])) %>% 
		filter(day >= 0, abx %in% antibiotic) %>% 
		mutate(CFU = log10(CFU + 60)) %>% 
		mutate_at(vars(contains('Otu')), function(otu) {log10(otu + 0.04)}) %>% 
		gather(otu, rel_abund, CFU, contains('Otu00')) %>% 
		#left_join(tax_df, by = c('otu' = 'OTU')) %>% 
		ggplot(aes(y = rel_abund, x = day)) + 
			geom_line(aes(color = otu, group = mouse_id)) + 
			theme_bw() + 
			facet_grid(otu~abx, scales = 'free_y') + 
			labs(x = 'Relative Abundance', y = 'C.difficile CFU')
}
plot_diff_corr(diff_trt_list[[1]])
plot_diff_corr(diff_trt_list[[2]])
plot_diff_corr(diff_trt_list[[3]])
plot_diff_corr(diff_trt_list[[4]])
plot_diff_corr(diff_trt_list[[5]])
plot_diff_corr(diff_trt_list[[6]])
plot_diff_corr(diff_trt_list[[7]])

# when selecting otus with a median abundance > 0, no change in OTUs correlate with changes in CFU
# however when using all otus, the most common is Clostridium XI (C. difficile) and the others are lowly abundant OTUs
# treatment
#  1 amp                             Herbaspirillum (OTU 344)              
#  2 amp                             Tumebacillus (OTU 444)                
#  3 amp                             Streptococcus (OTU 158)               
#  4 amp                             Clostridium_XI (OTU 33)               
#  5 clinda                          Clostridium_XI (OTU 33)               
#  6 strep                           Ruminococcaceae_unclassified (OTU 290)
#  7 strep                           Clostridium_XI (OTU 33)               
#  8 vanc                            Barnesiella (OTU 422)                 
#  9 vanc                            Clostridium_XI (OTU 33)               
# 10 clinda_vanc_amp_cef_metro_strep Tumebacillus (OTU 444)                
# 11 clinda_vanc_amp_cef_metro_strep Clostridium_XI (OTU 33)    
# 
# median_delta_ab…    rho   pvalue pvalue_BH pvalue_bon treatment Kingdom
#    <chr>            <dbl>  <dbl>    <dbl>     <dbl>      <dbl> <chr>     <chr>  
#  1 Otu0…                0 -0.298 3.18e- 5  9.27e- 3   1.85e- 2 amp       Bacter…
#  2 Otu0…                0 -0.275 1.27e- 4  2.47e- 2   7.40e- 2 amp       Bacter…
#  3 Otu0…                0  0.261 2.93e- 4  4.27e- 2   1.71e- 1 amp       Bacter…
#  4 Otu0…                0  0.405 7.79e- 9  4.54e- 6   4.54e- 6 amp       Bacter…
#  5 Otu0…                0  0.651 1.99e-10  8.07e- 8   8.07e- 8 clinda    Bacter…
#  6 Otu0…                0  0.322 2.14e- 5  5.64e- 3   1.13e- 2 strep     Bacter…
#  7 Otu0…                0  0.387 2.42e- 7  1.28e- 4   1.28e- 4 strep     Bacter…
#  8 Otu0…                0  0.289 3.41e- 5  1.32e- 2   2.65e- 2 vanc      Bacter…
#  9 Otu0…                0  0.374 5.10e- 8  3.96e- 5   3.96e- 5 vanc      Bacter…
# 10 Otu0…                0 -0.157 3.69e- 6  3.14e- 3   6.27e- 3 clinda_v… Bacter…
# 11 Otu0…                0  0.348 5.13e-26  8.72e-23   8.72e-23 clinda_v… Bacter…

```

Test for association between changes in C. difficile CFU and OTUs
- when selecting otus with a median abundance > 0, no change in OTUs correlate with changes in CFU
- when using all otus, the most common is Clostridium XI (C. difficile) and the others are lowly abundant OTUs with little variation 
- testing different subsets (those cleared, only those changing) did not reveal any further information



Does abundance, z-score, or change in abundance predict change in CFU?
	Model - RF/SVM/Logistic L2
	Prediction - Overall colonization trend, change in CFU, Endpoint cleared (T/F) or level (High/Mid/Low/None)
	Features - Temporal object, prior day level, change in abundance, summary of temporal abundance (mean/median/SD/min/max/trend), abundance metric (~RMS/area of movement)

```{r classify change in cfu}

####
# what features best classify CFU?
####

# WHat features at day 0 predict clearance?

# What features at endpoint classify clearance?

# When c diff decreases, what changes events preceding are the best classifiers?
#	OTU abundance?
#	change in OTU? change in rel abund? zscore?



```



What is the network interactions of each antibiotic?
	network via spieceasi

```{r network}

#library(devtools)
#install_github("zdk123/SpiecEasi")
library(SpiecEasi)
library(igraph)

get_se_network <- function(antibiotic){
	se_cdiff_df <- meta_file %>% 
		inner_join(clearance, by = 'mouse_id') %>% 
		filter(cdiff == T, clearance != 'colonized', day > 0, abx %in% antibiotic) %>% 
		inner_join(rel_abund, by = 'group') %>% 
		mutate(Otu00Cdiff = log10(CFU + 0.01)) %>% 
		select(contains('Otu')) %>% 
		as.matrix
	se_cdiff_df <- se_cdiff_df[ ,apply(se_cdiff_df, 2, function(x) sum(x > 0)) > 0.1*nrow(se_cdiff_df)]
	# the main SPIEC-EASI pipeline: Data transformation, sparse inverse covariance estimation and model selection
	se.mb.cdiff <- spiec.easi(se_cdiff_df, method='mb', lambda.min.ratio=1e-2,
		nlambda=20, pulsar.params=list(rep.num=50))
	#for actual run, use rep.num (99 or 999) 
	## set size of vertex proportional to clr-mean
	vsize    <- rowMeans(clr(se_cdiff_df, 1))+6

	ig.mb <- getRefit(se.mb.cdiff)
	colnames(ig.mb) <- rownames(ig.mb) <- gsub('Otu0*', '', colnames(se_cdiff_df))
	return(ig.mb)
	#cdiff.coord <- layout.fruchterman.reingold(ig.mb)
	#network_plot <- plot(ig.mb, layout=cdiff.coord, vertex.size=vsize, main = antibiotic)
	#ggsave(paste0('cdiff_network_', antibiotic, '_plot.jpg'), network_plot, width = 10, height = 10)
}

cef_se <- get_se_network('cef')
clinda_se <- get_se_network('clinda')
strep_se <- get_se_network('strep')

get_first_order <- function(data_input){
	first_order_otus <- c(names(which(data_input[,'Cdiff'] > 0)), 'Cdiff')
	#second_order_otus <- names(apply(data_input[,otus], 1 , sum) > 0)
	data_input <- data_input[first_order_otus, first_order_otus]
	#ig.mb <- ig.mb[second_order_otus, second_order_otus]
	first_order_network <- adj2igraph(data_input, 
		vertex.attr = list(name = colnames(data_input)))
	plot(first_order_network)
}

get_first_order(cef_se)
get_first_order(clinda_se)
get_first_order(strep_se)
plot(cef_se, layout = layout_as_star(cef_se, center = 'Cdiff'))
plot(cef_se, layout= layout_as_tree)

plot(ig.mb, layout = layout_as_star(ig.mb, center = 'Cdiff'))
plot(ig.mb, layout= layout_as_tree)

```


Generally in these experiements, Akkermansia seems to bloom in response to C. difficile colonization
-  Compare level of Akkermansia in samples with C. difficile and those without
-  Compare level of Akkermansia in samples challenged with C. difficile to the unchallenged samples

Are there any cases with similar communities but different colonization dynamics? 

What is the difference between uncolonized and colonized within the same treatments? Are those differences shared across treatments?
	Are they similar to features associated with clearance?


```{r analysis}

```