---
title: "Exploratory - C. difficile by Antibiotic"
author: "Nicholas Lesniak"
date: "1/16/2019"
output: html_document
---

```{r setup environment, include=F}
# setup data in environment
knitr::opts_chunk$set(echo = F, warning = F, message = F)

library(tidyverse)
library(cowplot)
library(hues)
library(bsselectR)

meta_file   <- '../data/process/abx_cdiff_metadata_clean.txt'
shared_file <- '../data/mothur/abx_time.trim.contigs.good.unique.good.filter.unique.precluster.pick.pick.pick.an.unique_list.0.03.subsample.shared'
taxonomy_file <- '../data/process/abx_cdiff_taxonomy_clean.tsv'
taxonomy_function <- '../code/sum_otu_by_taxa.R'

meta_df <- read.table(meta_file, sep = '\t', header = T, stringsAsFactors = F) %>% 
  mutate(treatment = paste(abx, dose, delayed, cdiff, sep = '_'),
    mouse_id = paste(cage, mouse, sep = '_')) 
shared_df <- read.table(shared_file, sep = '\t', header = T, row.names = 'Group')

# create position to group stacked bar plot by cage
mouse_label_df <- meta_df %>% 
  select(cage, mouse, treatment, mouse_id) %>% 
  unique %>% 
  group_by(treatment) %>% 
  arrange(cage, mouse) %>% 
  mutate(mouse_position = as.numeric(as.factor(mouse_id))) %>% 
  ungroup %>% 
  select(-cage, -mouse)

meta_df <- left_join(meta_df, mouse_label_df, by = c('treatment', 'mouse_id'))

source(taxonomy_function)
taxonomy_df <- read.table(taxonomy_file, sep = '\t', header = T, stringsAsFactors = F)

shared_df <- select(shared_df, -label, -numOtus)

sample_summed_counts <- apply(shared_df, 1, sum)
rel_abund <- data.frame(100 * shared_df/sample_summed_counts) %>% 
  mutate(group = rownames(shared_df))

```


# C. difficile Challenge by Antibiotic Treatments

The following antibiotics were used:

Antibiotic    | Treatment Variation    | Effect         |  Class          | Mode of action                           
------------- | ---------------------- | -------------- | --------------- | -----------------------------------------
Ampicilin     | Antibiotic Recovery    | bactericidal   | beta lactam     | inhibits cell wall (+/-)                 
Cefaperazone  | Dose (0.1, 0.3, 0.5)   | bactericidal   | beta lactam     | inhibits cell wall (+/-)                 
Clindamycin   | NA                     | bacteriostatic | lincosamide     | inhibits protein synthesis               
Ciprofloxacin | NA                     | bactericidal   | fluoroquinolone | inhibits DNA gyrase (+/-)                
Metronidazole | Antibiotic Recovery    | bactericidal   | nitroimidazole  | inhibits nucleic acid synthesis (aerobic)
Streptomycin  | Dose (0.1, 0.5, 5)     | bactericidal   | aminoglycoside  | inhibits protein synthesis (+/-)         
Vancomycin    | Dose (0.1, 0.3, 0.625) | bactericidal   | glycopeptide    | inhibits cell wall (+)                   


# How do communities change? with differing colonization?

Select the level and antibiotic you would like to view

```{r community changes}

# select samples for preAbx, pre-infection, end of experiment
pre_post_end_df <- meta_df  %>% 
  right_join(select(rel_abund, group), by = 'group') %>% 
  group_by(cage, mouse) %>% 
  mutate(endpoint = max(day),
    sample_timepoint = case_when(preAbx == T ~ 'initial',
      day == 0 ~ 'day_0',
      day == endpoint ~ 'endpoint',
      recovDays == 1 ~ 'pre-recovered',
      T ~ NA_character_)) %>%
  ungroup %>% 
  filter(!is.na(sample_timepoint)) %>% 
  select(-recovDays, -preAbx, -endpoint)

pre_post_end_phyla_df <- pre_post_end_df %>% 
    left_join(gather(
        sum_otu_by_taxa(taxonomy_df = taxonomy_df, otu_df = rel_abund, 
          taxa_level = 'Phylum'),
      taxa, abundance, -group), 
    by = 'group') %>% 
    mutate(dataset = 'phylum_level')

initial_colonization_df <- meta_df %>% 
  # to get level of colonization post C. difficile challenge, look of CFU on day 1 
  # but there are some cases day 1 might be deceptive so extending to day 2 
  # to see those that had delayed colonization
  filter(day %in% c(1:4)) %>% 
  group_by(cage, mouse) %>% 
  summarize(initial_colonization = max(CFU))

pre_post_end_genus_df <- pre_post_end_df %>% 
  split(.$treatment) %>% 
  map_dfr(function(df) left_join(df, 
        sum_otu_by_taxa(taxonomy_df = taxonomy_df, otu_df = filter(rel_abund, group %in% df$group), 
          taxa_level = 'Genus', top_n = 8),
      by = 'group'))  %>% 
  mutate(dataset = 'genus_level') 

pre_post_end_otu_df <- pre_post_end_df %>% 
  split(.$treatment) %>% 
  map_dfr(function(df) left_join(df, 
        sum_otu_by_taxa(taxonomy_df = taxonomy_df, otu_df = filter(rel_abund, group %in% df$group), 
          taxa_level = 'tax_otu_label', top_n = 8),
      by = 'group'))  %>% 
  mutate(dataset = 'OTU_level',
    taxa = gsub(' \\(', '\n(', taxa),
    taxa = gsub('_unclassified\n\\(', '\n(Unclassified, ', taxa))

barwidth <- 1

for(df in list(pre_post_end_phyla_df, pre_post_end_genus_df, pre_post_end_otu_df)){
  for(antibiotic in unique(pre_post_end_phyla_df$abx)){
    
    colors <- unname(iwanthue(df %>% 
            filter(abx == antibiotic) %>% 
            pull(taxa) %>% 
            unique %>% 
            length))
    
    community_plot <- df %>% 
      filter(abx == antibiotic) %>% 
      mutate(sample_timepoint = factor(sample_timepoint, c('initial', 'pre-recovered', 'day_0', 'endpoint')),
        taxa = factor(taxa, c('Other', unique(df$taxa)[unique(df$taxa)!='Other']))) %>% 
      ggplot(aes(x = mouse_position, y = abundance, fill = taxa)) + 
        geom_bar(stat="identity", position='stack', width = barwidth, color = "black", size = 0.1) + 
        facet_grid(treatment ~ sample_timepoint) + 
        theme_bw() + labs(x = NULL) + 
        theme(legend.position = 'top', legend.title=element_blank(),
          axis.text.x = element_blank(), axis.ticks.x = element_blank(),
          legend.text=element_text(size=6)) + 
        scale_fill_manual(values = colors)

    cdiff_plot <- pre_post_end_df %>% 
      filter(abx == antibiotic, sample_timepoint == 'endpoint') %>% 
      left_join(initial_colonization_df, by = c('mouse', 'cage')) %>% 
      rename(endpoint = CFU) %>% 
      gather(sample_timepoint, CFU, endpoint, initial_colonization) %>% 
      mutate(sample_timepoint = factor(sample_timepoint, c('initial_colonization', 'endpoint'))) %>% 
      ggplot(aes(x = mouse_position, y = CFU)) + 
        geom_bar(stat="identity", position='stack', width = barwidth) + 
        facet_grid(treatment ~ sample_timepoint) + 
        scale_y_log10() + 
        theme_bw() + labs(x = NULL, y = 'CFU (log10)', title = '\nEndpoint C. difficile Colonization',
          subtitle = '\nLabel = antibiotic_dose_delay_cdiff') + 
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

    plot_header <- ggdraw() +
     draw_label(paste0('Community overview at timepoint before antibiotic treatment, after ',
      antibiotic, ' looking at the ', unique(df$dataset)), x = 0.05, hjust = 0)

    ggsave(paste0('../results/figures/community_plots/', antibiotic, '_', unique(df$dataset), '.jpg'),
      plot_grid(plot_header, plot_grid(community_plot, cdiff_plot, rel_widths = c(2, 1)), 
        ncol = 1, rel_heights = c(0.1, 2)),
      width = 10, height = 10)
  }
}

abx_plots <- paste0(list.files("../results/figures/community_plots", full.names = TRUE))
names(abx_plots) <- str_replace_all(abx_plots, 
    c("\\.jpg" = "", 
      "../results/figures/community_plots/" = ""))

bsselect(abx_plots, type = "img", selected = "strep_phylum_level", height = '75', show_tick = TRUE)


```


```{r}
  
```

Descriptive Changes

Ampicilin - 5 day recovery

The antibiotic treatment seems to have a varied effect on the community changes
At the phylum level, antibiotic treament resulted in varied community effects which seem to group by cage. This could be due to the environment of the experiment (other treatments occuring at the same time) or possibly amp has a more vaired effect on the bacterial community.
  Inital antibiotic treatment lead to:
    1. Complete dominace of Proteobacteria (~90%)
    2. Partial dominance of Proteobacteria (~50%), 
    3. Increase in Proteobacteria (~25%), Decrease in bacteroidetes (70-80% -> ~50%), increase in akkermansia (10%)
  Recovery lead to different conditions
    1. Complete dominant Proteobacteria, after 10 days, returned to pre-antibiotic Bacteroidetes:Firmicutes ratio
    2. Partially dominant Proteobacteria conditions, after 10 days, became dominated by Firmicutes (~90%)
      The other group of partially dominant proteobactia were challenged with C. difficile
    3. Communities with slightly increased proteobacteria all we in the experimental group that recovered 5 days prior to C. difficile challenge. These communities recovered in 3 different ways
      a. Decrease in proteobacteria with an increase in bacteroidetes and akkermansia
      b. Domination of Firmicutes
      c. Elimination of Akkermansia and a ratio of bacteroidetes:firmicutes:proteobacteria of 3:1:1
  All communities were colonization
    The recovery group were colonized at a slightly lower level ~2 logs lower and one cage was ~10^4 at the end
    Communities changed during C. difficile infection
      No recovery All were highly colonized ~10^8 by day 2 and ~10^7 at day 10
        Bacteroides dominant community became ~1:1 Bacteroidetes:Firmicutes
        Partially dominat proteobacteria communities became dominated by Akkermansia (~70%)
      Recovered communites had three different outcomes
        a. the bacteroides/akkermansia community had akkermansia increase further (~30%)
        b. the firmicutes dominant communities became firmicutes/tenericutes/actinobacteria (7:2:1)
        c. the bacteroidetes:firmicutes:proteobacteria became bacteroidetes:firmicutes (3:1)
        the community of bacteroidetes/firmicutes/akkermansia had the lowest level of colonization (10^4)


From Exploratory.Rmd looking at all treatments together, 


How does C. difficile change the community?

How are resistant communities different than susceptible? (within antibiotic treatment)



What is different between persistent and clearing communities?


How to restore colonization resistance to Clindamycin?
  what changes precede or co-occur with decreasing CFU?

How do clinda and metro differ? What’s different after antibiotics (subtracting proteo)? What’s different in unchallenged communities for recovery?


## Comparing CFU vs Counts for detecting C. difficile

