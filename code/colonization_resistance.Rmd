---
title: "Exploratory - C. difficile by Antibiotic"
author: "Nicholas Lesniak"
date: "1/16/2019"
output: html_document
---

```{r setup environment, include=F}
# setup data in environment
knitr::opts_chunk$set(echo = F, warning = F, message = F)

library(tidyverse)
library(cowplot)
library(bsselectR)

meta_file   <- '../data/process/abx_cdiff_metadata_clean.txt'
shared_file <- '../data/mothur/abx_time.trim.contigs.good.unique.good.filter.unique.precluster.pick.pick.pick.an.unique_list.0.03.subsample.shared'
taxonomy_file <- '../data/mothur/abx_time.trim.contigs.good.unique.good.filter.unique.precluster.pick.pick.pick.an.unique_list.0.03.cons.taxonomy'
taxonomy_function <- '../code/sum_otu_by_taxa.R'

meta_df <- read.table(meta_file, sep = '\t', header = T, stringsAsFactors = F) %>% 
  mutate(treatment = paste(abx, dose, delayed, cdiff, sep = '_'),
    mouse_id = paste(cage, mouse, sep = '_')) 
shared_df <- read.table(shared_file, sep = '\t', header = T, row.names = 'Group')

# create position to group stacked bar plot by cage
mouse_label_df <- meta_df %>% 
  select(cage, mouse, treatment, mouse_id) %>% 
  unique %>% 
  group_by(treatment) %>% 
  arrange(cage, mouse) %>% 
  mutate(mouse_position = as.numeric(as.factor(mouse_id))) %>% 
  ungroup %>% 
  select(-cage, -mouse)

meta_df <- left_join(meta_df, mouse_label_df, by = c('treatment', 'mouse_id'))

source(taxonomy_function)
taxonomy_df <- read.table(taxonomy_file, sep = '\t', header = T)
taxonomy_labels <- get_taxa_labels(taxonomy_file)

cdiff_otus <- as.character(taxonomy_df$OTU[grep('Clostridium_XI', taxonomy_df$Taxonomy)])
entercoccus_otus <- as.character(taxonomy_df$OTU[grep('Enterococcus', taxonomy_df$Taxonomy)])

numotus <- shared_df$numOtus[1]

shared_cdiff_df <- apply(select(shared_df, one_of(cdiff_otus)), 1, sum)
shared_cdiff_df <- data.frame(group = names(shared_cdiff_df), c_difficile = unname(shared_cdiff_df), stringsAsFactors = F) %>% 
  mutate(C.difficile = c_difficile/numotus)

shared_df <- select(shared_df, -label, -numOtus, -one_of(cdiff_otus))

otu_presence_cutoff <- 0.05
otu_presence <- ifelse(shared_df > 0, T, F) 
OTUs_present <- colnames(shared_df[ , apply(otu_presence, 2, sum) > 
                                        round(otu_presence_cutoff*nrow(shared_df))])
#relative abundance of OTUs present in >5% of samples
#rel_abund <- shared_file[ ,OTUs_present]/OTU_total*100
counts <- apply(shared_df, 1, sum)
rel_abund <- data.frame(apply(shared_df[ ,OTUs_present], 2, function(i){(i/counts)*100}))

```


# C. difficile Challenge by Antibiotic Treatments

The following antibiotics were used:

Antibiotic    | Treatment Variation    | Effect         |  Class          | Mode of action                           
------------- | ---------------------- | -------------- | --------------- | -----------------------------------------
Ampicilin     | Antibiotic Recovery    | bactericidal   | beta lactam     | inhibits cell wall (+/-)                 
Cefaperazone  | Dose (0.1, 0.3, 0.5)   | bactericidal   | beta lactam     | inhibits cell wall (+/-)                 
Clindamycin   | NA                     | bacteriostatic | lincosamide     | inhibits protein synthesis               
Ciprofloxacin | NA                     | bactericidal   | fluoroquinolone | inhibits DNA gyrase (+/-)                
Metronidazole | Antibiotic Recovery    | bactericidal   | nitroimidazole  | inhibits nucleic acid synthesis (aerobic)
Streptomycin  | Dose (0.1, 0.5, 5)     | bactericidal   | aminoglycoside  | inhibits protein synthesis (+/-)         
Vancomycin    | Dose (0.1, 0.3, 0.625) | bactericidal   | glycopeptide    | inhibits cell wall (+)                   


# How do communities change? with differing colonization?

Select the level and antibiotic you would like to view

```{r community changes}

# select samples for preAbx, pre-infection, end of experiment
pre_post_end_df <- meta_df  %>% 
  right_join(select(mutate(rel_abund, group = rownames(rel_abund)), group), by = 'group') %>% 
  group_by(cage, mouse) %>% 
  mutate(endpoint = max(day),
    sample_timepoint = case_when(preAbx == T ~ 'initial',
      day == 0 ~ 'day_0',
      day == endpoint ~ 'endpoint',
      recovDays == 1 ~ 'pre-recovered',
      T ~ NA_character_)) %>%
  ungroup %>% 
  filter(!is.na(sample_timepoint)) %>% 
  select(-recovDays, -preAbx, -endpoint)

pre_post_end_phyla_df <- pre_post_end_df %>% 
    left_join(gather(
        sum_otu_by_taxa(taxonomy_file = taxonomy_file, otu_df = rel_abund, 
          taxa_level = 'phylum'),
      taxa, abundance, -group), 
    by = 'group') %>% 
    mutate(dataset = 'phylum_level')

initial_colonization_df <- meta_df %>% 
  # to get level of colonization post C. difficile challenge, look of CFU on day 1 
  # but there are some cases day 1 might be deceptive so extending to day 2 
  # to see those that had delayed colonization
  filter(day %in% c(1:4)) %>% 
  group_by(cage, mouse) %>% 
  summarize(initial_colonization = max(CFU))

pre_post_end_genus_df <- pre_post_end_df %>% 
  left_join(gather(
      sum_otu_by_taxa(taxonomy_file = taxonomy_file, otu_df = rel_abund, 
        taxa_level = 'genus'),
      taxa, abundance, -group), 
    by = 'group') %>% 
  mutate(dataset = 'genus_level') %>% 
  right_join(group_by(., treatment, taxa) %>% 
    summarise(median_abundance = mean(abundance, na.rm = T)) %>% 
    group_by(treatment) %>% 
    top_n(8, median_abundance) %>% 
    select(treatment, taxa), by  = c('treatment', 'taxa')) %>% 
  mutate(taxa = gsub('unclassified_', '', taxa))

top_otus_by_treatment <-  meta_df %>% 
  left_join(mutate(rel_abund, group = rownames(rel_abund)), by = 'group') %>% 
  gather(otu, abundance, contains('Otu00')) %>% 
  group_by(treatment, otu) %>% 
  summarise(median_abundance = mean(abundance, na.rm = T)) %>% 
  group_by(treatment) %>% 
  top_n(8, median_abundance) %>% 
  select(treatment, otu)

pre_post_end_otu_df <- left_join(pre_post_end_df,
    mutate(rel_abund, group = rownames(rel_abund)), by = 'group') %>%   
  gather(otu, abundance, contains('Otu00')) %>% 
  right_join(top_otus_by_treatment, by = c('treatment', 'otu')) %>% 
  left_join(select(taxonomy_labels, otu, tax_otu_label), by = 'otu') %>% 
  mutate(taxa = gsub(' \\(', '\n(', tax_otu_label),
    taxa = gsub('unclassified_', '', taxa)) %>% 
  mutate(dataset = 'top_OTUs')
barwidth <- 1

for(df in list(pre_post_end_phyla_df, pre_post_end_genus_df, pre_post_end_otu_df)){
  for(antibiotic in unique(pre_post_end_phyla_df$abx)){

    community_plot <- df %>% 
      filter(abx == antibiotic) %>% 
      mutate(sample_timepoint = factor(sample_timepoint, c('initial', 'pre-recovered', 'day_0', 'endpoint'))) %>% 
      ggplot(aes(x = mouse_position, y = abundance, fill = taxa)) + 
        geom_bar(stat="identity", position='stack', width = barwidth, color = "black", size = 0.1) + 
        facet_grid(treatment ~ sample_timepoint) + 
        theme_bw() + labs(x = NULL) + 
        theme(legend.position = 'top', legend.title=element_blank(),
          axis.text.x = element_blank(), axis.ticks.x = element_blank(),
          legend.text=element_text(size=6))

    cdiff_plot <- pre_post_end_df %>% 
      filter(abx == antibiotic, sample_timepoint == 'endpoint') %>% 
      left_join(initial_colonization_df, by = c('mouse', 'cage')) %>% 
      rename(endpoint = CFU) %>% 
      gather(sample_timepoint, CFU, endpoint, initial_colonization) %>% 
      mutate(sample_timepoint = factor(sample_timepoint, c('initial_colonization', 'endpoint'))) %>% 
      ggplot(aes(x = mouse_position, y = CFU)) + 
        geom_bar(stat="identity", position='stack', width = barwidth) + 
        facet_grid(treatment ~ sample_timepoint) + 
        scale_y_log10() + 
        theme_bw() + labs(x = NULL, y = 'CFU (log10)', title = '\nEndpoint C. difficile Colonization',
          subtitle = '\nLabel = antibiotic_dose_delay_cdiff') + 
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

    plot_header <- ggdraw() +
     draw_label(paste0('Community overview at timepoint before antibiotic treatment, after ',
      antibiotic, ' looking at the ', unique(df$dataset)), x = 0.05, hjust = 0)

    ggsave(paste0('../results/figures/community_plots/', antibiotic, '_', unique(df$dataset), '.jpg'),
      plot_grid(plot_header, plot_grid(community_plot, cdiff_plot, rel_widths = c(2, 1)), 
        ncol = 1, rel_heights = c(0.1, 2)),
      width = 10, height = 10)
  }
}

abx_plots <- paste0(list.files("../results/figures/community_plots", full.names = TRUE))
names(abx_plots) <- str_replace_all(abx_plots, 
    c("\\.jpg" = "", 
      "../results/figures/community_plots/" = ""))

bsselect(abx_plots, type = "img", selected = "strep_phylum_level", height = '75', show_tick = TRUE)


```


```{r}
  
```

From Exploratory.Rmd looking at all treatments together, 


How does C. difficile change the community?

How are resistant communities different than susceptible? (within antibiotic treatment)



What is different between persistent and clearing communities?


How to restore colonization resistance to Clindamycin?
  what changes precede or co-occur with decreasing CFU?




## Comparing CFU vs Counts for detecting C. difficile

